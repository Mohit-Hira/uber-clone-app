{% extends 'base.html' %}

{% block head_scripts %}
<script async defer
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAzgs2AEHlWF1e6H005TUOFQ2RLMtvZuAg&libraries=places,geometry&callback=initDriverMap">
</script>
{% endblock %}

{% block content %}
<div class="driver-container">
  <h2>Driver Dashboard</h2>
  <button id="toggle-location">driver info at the end </button>

  <div id="ride-info">
    <h3>Assigned Ride</h3>
    <p><strong>Pickup:</strong> <span id="pickup-address"></span></p>
    <p><strong>Destination:</strong> <span id="destination-address"></span></p>
    <p><strong>Distance:</strong> <span id="distance"></span> km</p>
    <p><strong>Fare:</strong> $<span id="fare"></span></p>
  </div>

  <div id="map" style="width:100%; height:400px; border-radius:12px; border:1px solid #ddd; margin-top:20px;"></div>
</div>

<style>
body {
  background: #f5f5f5;
  color: #222;
  font-family: 'Poppins', sans-serif;
}
.driver-container {
  max-width: 800px;
  margin: 40px auto;
  background: #fff;
  padding: 30px;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
h2, h3 { color: #111; }
button {
  background: #FFD700;
  color: #111;
  border: none;
  padding: 10px 18px;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: 0.3s;
}
button:hover { background: #e6c200; }
#ride-info {
  background: #fafafa;
  border: 1px solid #ddd;
  border-radius: 8px;
  padding: 16px;
  margin-top: 20px;
}
#driver-info {
  background: #f0f8ff;
  border: 1px solid #cce5ff;
  border-radius: 8px;
  padding: 16px;
  margin-top: 20px;
}
</style>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, doc, setDoc, GeoPoint } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

// ---------------- Firebase Config ----------------
const firebaseConfig = {
  apiKey: "AIzaSyC5OHYo2lXfhLLK85MTUyucWRJarnX68nw",
  authDomain: "example3-35a7d.firebaseapp.com",
  projectId: "example3-35a7d",
  storageBucket: "example3-35a7d.firebasestorage.app",
  messagingSenderId: "322152991485",
  appId: "1:322152991485:web:89642e8908e85de5b90c94"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let watchId = null;
let map, directionsService, directionsRenderer;

window.initDriverMap = function() {
  const params = new URLSearchParams(window.location.search);
  let rideData = null;

  if (params.has("ride")) {
    rideData = JSON.parse(decodeURIComponent(params.get("ride")));
    document.getElementById("pickup-address").textContent = rideData.pickup.address;
    document.getElementById("destination-address").textContent = rideData.destination.address;
    document.getElementById("distance").textContent = rideData.distance.toFixed(2);
    document.getElementById("fare").textContent = rideData.fare.toFixed(2);
  } else {
    document.getElementById("ride-info").innerHTML = "<p><em>No ride assigned yet.</em></p>";
  }

  // Initialize Map
  map = new google.maps.Map(document.getElementById("map"), {
    center: rideData ? rideData.pickup : { lat: 40.7128, lng: -74.0060 },
    zoom: 13
  });

  directionsService = new google.maps.DirectionsService();
  directionsRenderer = new google.maps.DirectionsRenderer({ map });

  if (rideData) {
    const pickup = new google.maps.LatLng(rideData.pickup.lat, rideData.pickup.lng);
    const destination = new google.maps.LatLng(rideData.destination.lat, rideData.destination.lng);
    directionsService.route(
      { origin: pickup, destination, travelMode: 'DRIVING' },
      (res, status) => { if (status === "OK") directionsRenderer.setDirections(res); }
    );
  }

  const toggleBtn = document.getElementById("toggle-location");

onAuthStateChanged(auth, (user) => {
  if (!user) return; // just silently do nothing if somehow user is missing


    toggleBtn.addEventListener("click", async () => {
      if (!navigator.geolocation) {
        alert("Geolocation not supported by your browser.");
        return;
      }

      if (!rideData) {
        alert("No ride assigned. Please wait for a ride before going online.");
        return;
      }

      // Hide button
      toggleBtn.style.display = "none";

      // Driver info card
      const driverName = user.displayName || "Driver " + user.uid.substring(0, 6);
      const badgeNo = Math.floor(1000 + Math.random() * 9000);

      const infoBox = document.createElement("div");
      infoBox.id = "driver-info";
      infoBox.innerHTML = `
        <h4>ðŸš— Driver Info</h4>
        <p><strong>Name:</strong> ${driverName}</p>
        <p><strong>Badge No:</strong> ${badgeNo}</p>
        <p id="eta"><strong>ETA to pickup:</strong> calculating...</p>
        <button id="go-offline">hide driver info</button>
      `;
      document.querySelector(".driver-container").appendChild(infoBox);

      const offlineBtn = document.getElementById("go-offline");
      offlineBtn.addEventListener("click", async () => {
        if (watchId) {
          navigator.geolocation.clearWatch(watchId);
          watchId = null;
        }
        await setDoc(doc(db, "drivers", user.uid), { online: false }, { merge: true });
        infoBox.remove();
        toggleBtn.style.display = "inline-block";
        console.log("Driver is offline");
      });

      // Start location tracking
      watchId = navigator.geolocation.watchPosition(async (pos) => {
        const driverRef = doc(db, "drivers", user.uid);
        await setDoc(driverRef, {
          name: driverName,
          badgeNo: badgeNo,
          location: new GeoPoint(pos.coords.latitude, pos.coords.longitude),
          online: true,
          updatedAt: new Date()
        }, { merge: true });

        console.log("Driver location updated:", pos.coords);

        // ETA calculation (depends on distance)
        const service = new google.maps.DistanceMatrixService();
        service.getDistanceMatrix({
          origins: [{ lat: pos.coords.latitude, lng: pos.coords.longitude }],
          destinations: [rideData.pickup],
          travelMode: 'DRIVING'
        }, (res, status) => {
          if (status === "OK") {
            const result = res.rows[0].elements[0];
            const etaText = result.duration.text;
            const distText = result.distance.text;
            document.getElementById("eta").innerHTML =
              `<strong>ETA to pickup:</strong> ${etaText} (${distText})`;
          }
        });
      }, (err) => console.error(err), { enableHighAccuracy: true });
    });
  });
};
</script>
{% endblock %}
