{% extends 'base.html' %}

{% block head_scripts %}
<script async defer
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAXnQZbeAmsXAb0wmhu9lCeHBT0SFT9G2M&libraries=places,geometry&callback=initMap">
</script>
{% endblock %}

{% block content %}
<div class="uber-container">
  <h2 class="uber-header">Request Your Ride</h2>

  <div class="map-wrapper">
    <div id="map" class="map-box"></div>

    <div class="fare-panel">
      <h3>Fare Estimate</h3>
      <p><strong id="fare-display">Select locations to calculate</strong></p>

      <div class="ride-type">
        <label><input type="radio" name="ride" value="UberX" checked> UberX</label>
        <label><input type="radio" name="ride" value="UberPool"> UberPool</label>
      </div>

      <button id="confirm-btn">Set Pickup & Destination</button>
    </div>
  </div>
</div>

<!-- Modal for pickup & destination -->
<div id="location-dialog" class="modal">
  <div class="modal-content">
    <h3>Select Pickup & Destination</h3>

    <!-- Pickup options -->
    <label>
      <input type="radio" name="pickup-option" value="current" checked> Use My Current Location
    </label>
    <label>
      <input type="radio" name="pickup-option" value="manual"> Select Another Pickup Location
    </label>

    <input id="pickup-input" type="text" placeholder="Enter pickup location..." style="display:none;" />
    <br>

    <input id="destination-input" type="text" placeholder="Enter destination..." />

    <div class="modal-actions">
      <button id="cancel-btn">Cancel</button>
      <button id="confirm-location">Confirm</button>
    </div>
  </div>
</div>

<style>
.map-box { width: 100%; height: 500px; border-radius: 12px; }
.modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000; }
.modal-content { background: white; padding: 20px; border-radius: 12px; min-width: 320px; }
.modal-content input { width: 100%; padding: 10px; margin-bottom: 10px; font-size: 16px; border-radius: 8px; border: 1px solid #ccc; }
</style>

<script>
let map, directionsService, directionsRenderer;
let pickupPlace = null, destinationPlace = null;

function calculateFare(distanceKm, rideType) {
  const baseFare = rideType === "UberX" ? 2.5 : 1.5;
  const perKm = rideType === "UberX" ? 1.2 : 0.8;
  return baseFare + distanceKm * perKm;
}

window.initMap = () => {
  map = new google.maps.Map(document.getElementById("map"), { center: { lat: 37.7749, lng: -122.4194 }, zoom: 13 });
  directionsService = new google.maps.DirectionsService();
  directionsRenderer = new google.maps.DirectionsRenderer({ map });

  // Current location marker
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos => {
      const userPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
      map.setCenter(userPos);
      new google.maps.Marker({ position: userPos, map, title: "You are here" });
    });
  }

  const modal = document.getElementById("location-dialog");
  const confirmBtn = document.getElementById("confirm-btn");
  const confirmLocation = document.getElementById("confirm-location");
  const cancelBtn = document.getElementById("cancel-btn");
  const pickupOptionRadios = document.getElementsByName("pickup-option");

  const pickupInput = document.getElementById("pickup-input");
  const destinationInput = document.getElementById("destination-input");

  const pickupAutocomplete = new google.maps.places.Autocomplete(pickupInput);
  const destinationAutocomplete = new google.maps.places.Autocomplete(destinationInput);

  pickupAutocomplete.addListener("place_changed", () => pickupPlace = pickupAutocomplete.getPlace());
  destinationAutocomplete.addListener("place_changed", () => destinationPlace = destinationAutocomplete.getPlace());

  // Toggle pickup input based on selection
  pickupOptionRadios.forEach(radio => {
    radio.addEventListener("change", () => {
      pickupInput.style.display = radio.value === "manual" ? "block" : "none";
    });
  });

  confirmBtn.addEventListener("click", () => modal.style.display = "flex");
  cancelBtn.addEventListener("click", () => modal.style.display = "none");

  confirmLocation.addEventListener("click", () => {
    const selectedOption = document.querySelector('input[name="pickup-option"]:checked').value;

    if (selectedOption === "current") {
      if (!navigator.geolocation) { alert("Geolocation not supported!"); return; }
      navigator.geolocation.getCurrentPosition(pos => {
        const pickup = new google.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
        handleRideConfirmation(pickup, "Current Location");
      }, () => { alert("Unable to get location. Please select manually."); });
    } else {
      if (!pickupPlace?.geometry) { alert("Please select a pickup location!"); return; }
      handleRideConfirmation(pickupPlace.geometry.location, pickupPlace.formatted_address);
    }
  });
};

function handleRideConfirmation(pickup, pickupAddress) {
  if (!destinationPlace?.geometry) { alert("Please select a destination!"); return; }
  const destination = destinationPlace.geometry.location;
  const rideType = document.querySelector('input[name="ride"]:checked').value;

  directionsService.route({ origin: pickup, destination, travelMode: "DRIVING" }, (res, status) => {
    if (status === "OK") {
      directionsRenderer.setDirections(res);
      const route = res.routes[0].legs[0];
      const distanceKm = route.distance.value / 1000;
      const fare = calculateFare(distanceKm, rideType);

      // Send ride data to driver page
      const rideData = {
        pickup: { lat: pickup.lat(), lng: pickup.lng(), address: pickupAddress },
        destination: { lat: destination.lat(), lng: destination.lng(), address: destinationPlace.formatted_address },
        distance: distanceKm,
        fare,
        type: rideType
      };

      window.location.href = `/driver?ride=${encodeURIComponent(JSON.stringify(rideData))}`;
    } else { alert("Directions request failed: " + status); }
  });

  document.getElementById("location-dialog").style.display = "none";
}
</script>
{% endblock %}
